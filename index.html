<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRAMATIQUÊS - Prática de Gramática Portuguesa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto+Slab:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f0f0; /* Cinza claro sólido */
        }
        .title-font {
            font-family: 'Roboto Slab', serif;
        }
        .option-btn {
            transition: all 0.2s ease-in-out;
            /* Novos estilos para os botões de opção */
            background-color: #e0f7fa; /* light-blue-50 */
            border-color: #81d4fa; /* light-blue-200 */
            color: #006064; /* deep-teal-800 */
        }
        .option-btn:hover {
            background-color: #b2ebf2; /* light-blue-100 */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .correct {
            background-color: #22c55e !important; /* green-500 */
            color: white !important;
            border-color: #16a34a; /* green-600 */
            transform: scale(1.02);
        }
        .incorrect {
            background-color: #ef4444 !important; /* red-500 */
            color: white !important;
            border-color: #dc2626; /* red-600 */
        }
        .disabled {
            pointer-events: none;
            opacity: 0.9;
        }
        .topic-card {
            page-break-inside: avoid;
            break-inside: avoid;
            /* Novos estilos para os cartões de tópico */
            border-left: 8px solid #0ea5e9; /* sky-500 */
            transition: all 0.2s ease-in-out;
        }
        .topic-card:hover {
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-3px);
        }
        #topic-list {
            column-count: 1;
        }
        @media (min-width: 768px) {
            #topic-list {
                column-count: 2;
            }
        }
        /* Estilos para o Modal */
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-container {
            transition: all 0.3s ease;
            /* Ajustes para o tamanho e rolagem dos modais */
            max-height: 90vh; /* Limita a altura máxima para caber na tela */
            overflow-y: auto; /* Adiciona rolagem vertical se o conteúdo exceder a altura */
        }
        /* Estilos para o spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6; /* blue-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Estilo para o popup de informações */
        .info-popup {
            position: absolute;
            bottom: 1.5rem; /* Ajustado para descer mais */
            right: 0.5rem; /* Mantido no canto direito */
            background-color: #fff;
            padding: 0.6rem 0.8rem; /* Reduzido em aproximadamente 20% */
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            font-size: 0.7rem; /* Reduzido em aproximadamente 20% */
            color: #475569; /* slate-600 */
            z-index: 50; /* Garante que fique acima de outros elementos */
        }
        /* Ajuste para a tela inicial para permitir posicionamento absoluto do popup */
        #home-screen {
            position: relative; /* Necessário para posicionar o popup absolutamente dentro dela */
            overflow: hidden; /* Para garantir que o fundo de texto não vaze */
        }
        /* Estilo para o fundo de texto transparente */
        .text-background-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Permite cliques nos elementos abaixo */
            z-index: 1; /* Garante que fique atrás do conteúdo principal */
            color: rgba(200, 200, 200, 0.15); /* Cinza muito claro com mais transparência */
            font-size: 1.8rem; /* Ligeiramente maior */
            line-height: 1.8;
            text-align: center;
            overflow: hidden;
            word-break: break-all;
            white-space: pre-wrap; /* Preserva espaços em branco e quebras de linha */
            user-select: none; /* Impede seleção de texto */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.05); /* Sombra sutil para efeito 3D */
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 100px,
                rgba(220, 220, 220, 0.05) 100px, /* Ajuste para mais transparência no gradiente também */
                rgba(220, 220, 220, 0.05) 200px
            );
        }
        /* Estilo para o ícone do professor no modal */
        .professor-icon {
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.5rem;
            color: #1d4ed8; /* blue-700 */
        }
        /* Estilo para o ícone de ajuda */
        .help-icon {
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.5rem;
            color: #fff; /* white */
        }
        /* Estilo para o iframe do YouTube */
        .video-responsive {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            max-width: 100%;
            background: #000;
            border-radius: 0.5rem;
        }
        .video-responsive iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
        .difficulty-label.selected,
        .response-mode-label.selected { /* Adicionado para o modo de resposta */
            background-color: #3b82f6; /* blue-500 */
            color: white;
            border-color: #3b82f6;
        }

        /* Estilos para a Tela Final */
        #final-screen {
            background: linear-gradient(to bottom right, #e0f2fe, #bbdefb); /* Gradiente azul claro */
            border-radius: 1.5rem; /* Cantos mais arredondados */
            padding: 3rem; /* Mais padding */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15); /* Sombra mais pronunciada */
            animation: fadeInScale 0.5s ease-out forwards;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        #final-screen h2 {
            color: #1e40af; /* Azul mais escuro */
            font-size: 3.5rem; /* Título maior */
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        #final-screen #final-topic {
            color: #1d4ed8; /* Azul médio */
            font-size: 1.75rem;
            margin-bottom: 1.5rem;
        }

        #final-screen .text-lg.text-slate-600 {
            color: #475569; /* Cinza slate */
            font-weight: 500;
        }

        #final-screen #final-score {
            color: #059669; /* Verde esmeralda */
            font-size: 7rem; /* Pontuação gigante */
            font-weight: 800;
            margin-bottom: 2rem;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.2);
        }

        #final-screen #final-time {
            color: #64748b; /* Cinza mais escuro */
            font-size: 1.25rem;
            margin-bottom: 2.5rem;
        }

        #final-screen .flex button {
            padding: 1rem 2rem;
            border-radius: 9999px; /* Botões completamente arredondados */
            font-size: 1.1rem;
            font-weight: 700;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #final-screen #restart-quiz {
            background-color: #2563eb; /* Azul vibrante */
            color: white;
            border: 2px solid #1d4ed8;
        }
        #final-screen #restart-quiz:hover {
            background-color: #1d4ed8;
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2);
        }

        #final-screen #back-to-menu-final,
        #final-screen #back-to-home-from-final {
            background-color: #cbd5e1; /* Cinza mais claro */
            color: #334155;
            border: 2px solid #94a3b8;
        }
        #final-screen #back-to-menu-final:hover,
        #final-screen #back-to-home-from-final:hover {
            background-color: #94a3b8;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2);
        }

        /* Novo estilo para o modal de texto */
        .text-modal-content {
            background-color: #fff; /* Fundo branco */
            border: 1px solid #e0e0e0; /* Borda sutil */
            border-radius: 8px;
            padding: 1.5rem;
            line-height: 1.6;
            font-size: 1rem;
            color: #333;
            max-height: 70vh; /* Altura máxima para rolagem */
            overflow-y: auto; /* Habilita a rolagem vertical */
            box-shadow: inset 0 0 5px rgba(0,0,0,0.05); /* Sombra interna sutil */
            position: relative;
            background-image: linear-gradient(to bottom, #f9f9f9 1px, transparent 1px); /* Linhas de caderno */
            background-size: 100% 1.8em; /* Altura da linha */
        }
        .text-modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 40px; /* Margem esquerda para a linha vertical */
            bottom: 0;
            width: 1px;
            background-color: rgba(255, 0, 0, 0.2); /* Linha vertical vermelha clara */
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-3xl mx-auto">
        
        <!-- Tela Inicial (Home Screen) -->
        <div id="home-screen" class="text-center">
            <!-- Fundo de texto transparente -->
            <div class="text-background-overlay">
                Gramática Morfologia Sintaxe Fonética Fonologia Acentuação Ortografia Hífen Fonemas Encontros Vocálicos Substantivo Adjetivo Verbo Artigo Pronome Advérbio Preposição Conjunção Numeral Interjeição Morfema Termos Essenciais Sujeito Predicado Termos Integrantes Objeto Direto Objeto Indireto Complemento Nominal Agente da Passiva Termos Acessórios Adjunto Adnominal Adjunto Adverbial Aposto Vocativo Concordância Verbal Concordância Nominal Regência Verbal Regência Nominal Transitividade Verbal Vozes do Verbo Voz Ativa Voz Passiva Voz Reflexiva Uso da Vírgula Crase Orações Reduzidas Colocação Pronominal Funções do Que e Se Pontuação Português Língua Portuguesa Estudo Prática Aprender Conhecimento
            </div>

            <header class="mb-10 relative z-10">
                <h1 class="text-5xl md:text-6xl font-bold text-slate-700 title-font">GRAMATIQUÊS</h1>
                <p class="text-slate-500 mt-2 text-lg">Aprenda e pratique a gramática de forma simples!</p>
            </header>
            <main class="flex justify-center items-center h-64 relative z-10">
                <!-- Ícone SVG com corte lateral no primeiro círculo -->
                <svg class="w-48 h-48 text-sky-600 drop-shadow-lg" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <!-- Círculo externo com corte lateral -->
                    <path d="M 18 4 A 10 10 0 1 0 18 20" stroke="currentColor" stroke-width="2" fill="none"/>
                    <!-- Círculo interno -->
                    <circle cx="12" cy="12" r="5" fill="currentColor"/>
                </svg>
            </main>
            <div class="mt-8 relative z-10">
                <h3 class="text-2xl font-bold text-slate-700 mb-4">Selecione seu nível:</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6 max-w-2xl mx-auto">
                    <button id="level-6ef" class="level-select-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg" data-level="6EF">
                        6º Ano (Ensino Fundamental)
                    </button>
                    <button id="level-7ef" class="level-select-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg" data-level="7EF">
                        7º Ano (Ensino Fundamental)
                    </button>
                    <button id="level-8ef" class="level-select-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg" data-level="8EF">
                        8º Ano (Ensino Fundamental)
                    </button>
                    <button id="level-9ef" class="level-select-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg" data-level="9EF">
                        9º Ano (Ensino Fundamental)
                    </button>
                    <button id="level-1em" class="level-select-btn bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg" data-level="1EM">
                        1º Ano (Ensino Médio)
                    </button>
                    <button id="level-2em" class="level-select-btn bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg" data-level="2EM">
                        2º Ano (Ensino Médio)
                    </button>
                    <button id="level-3em" class="level-select-btn bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg" data-level="3EM">
                        3º Ano (Ensino Médio)
                    </button>
                    <button id="level-enem" class="level-select-btn bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg" data-level="enem">
                        ENEM
                    </button>
                </div>
                <button id="enter-app-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-8 rounded-lg transition-colors shadow-lg opacity-50 cursor-not-allowed" disabled>
                    Iniciar
                </button>
            </div>
            <footer class="mt-8 relative z-10 text-xs text-slate-500">
                <p>Desenvolvido por: Prof.º Marlon Costa - Língua Portuguesa e Literatura / Gramatiquês Versão 1.0</p>
            </footer>
        </div>

        <!-- Tela de Seleção de Tópico (para níveis não-concurseiro) -->
        <div id="topic-selection-screen" class="hidden">
            <header class="text-center mb-10">
                <h1 class="text-5xl md:text-6xl font-bold text-slate-700 title-font">GRAMATIQUÊS</h1>
                <p class="text-slate-500 mt-2 text-lg">Selecione um ou mais tópicos para estudar ou praticar.</p>
            </header>
            <main id="topic-container-quiz" class="space-y-8">
                <!-- Categorias e Tópicos serão inseridos aqui -->
            </main>
            <footer class="mt-8 text-center flex flex-col sm:flex-row justify-center items-center gap-4">
                <div class="flex items-center gap-2">
                    <label for="question-quantity-quiz" class="text-slate-700 font-semibold">Questões:</label>
                    <input type="number" id="question-quantity-quiz" value="10" min="1" class="w-20 p-2 border border-slate-300 rounded-lg text-center">
                </div>
                <button id="start-selected-quiz" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-8 rounded-lg transition-colors shadow-lg opacity-50 cursor-not-allowed" disabled>
                    Iniciar Quiz com Tópicos Selecionados
                </button>
                <!-- Novo botão para voltar à tela inicial -->
                <button id="back-to-home-from-topics" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-3 px-6 rounded-lg transition-colors">
                    Voltar para o Início
                </button>
            </footer>
        </div>

        <!-- Tela de Configuração do Simulado (para nível Concurseiro) -->
        <div id="simulado-setup-screen" class="hidden">
            <header class="text-center mb-10">
                <h1 class="text-5xl md:text-6xl font-bold text-slate-700 title-font">SIMULADO GRAMATIQUÊS</h1>
                <p class="text-slate-500 mt-2 text-lg">Selecione os tópicos e configure seu simulado.</p>
            </header>
            <main id="topic-container-simulado" class="space-y-8">
                <!-- Categorias e Tópicos serão inseridos aqui -->
            </main>
            <div class="mt-8 text-center flex flex-col items-center gap-4">
                <!-- Botões de configuração -->
                <div class="flex flex-wrap justify-center gap-4 w-full max-w-lg mx-auto">
                    <div class="flex flex-col items-center">
                        <button id="btn-num-questions" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg">
                            Nº de Questões
                        </button>
                        <p id="display-num-questions" class="text-black font-bold text-sm mt-1">---</p>
                    </div>
                    <div class="flex flex-col items-center">
                        <button id="btn-difficulty" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg">
                            Nível
                        </button>
                        <p id="display-difficulty" class="text-black font-bold text-sm mt-1">---</p>
                    </div>
                    <div class="flex flex-col items-center">
                        <button id="btn-response-mode" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg">
                            Tipo de Gabarito
                        </button>
                        <p id="display-response-mode" class="text-black font-bold text-sm mt-1">---</p>
                    </div>
                </div>
                
                <button id="start-simulado" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition-colors shadow-lg opacity-50 cursor-not-allowed mt-6">
                    Iniciar Simulado
                </button>
                <button id="back-to-home-from-simulado-setup" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-3 px-6 rounded-lg transition-colors">
                    Voltar para o Início
                </button>
            </div>
        </div>

        <!-- Tela do Quiz -->
        <div id="quiz-screen" class="hidden">
            <header class="mb-8 p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl shadow-md max-w-2xl mx-auto">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 id="quiz-topic-title" class="text-2xl font-bold text-sky-700"></h2>
                        <p id="question-counter" class="text-slate-500"></p>
                    </div>
                    <div class="text-right">
                        <p class="text-slate-500">Pontuação</p>
                        <p id="score" class="text-2xl font-bold text-slate-700">0</p>
                    </div>
                </div>
                <!-- Timer para Simulado -->
                <div id="timer-display-container" class="text-center text-lg font-semibold text-slate-700 mb-4 hidden">
                    Tempo: <span id="timer-display">00:00</span>
                </div>
                <!-- Barra de Progresso -->
                <div class="w-full bg-blue-200 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-sky-500 h-2.5 rounded-full transition-all duration-300 ease-out" style="width: 0%;"></div>
                </div>
            </header>

            <main id="question-container" class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 md:p-8 rounded-xl shadow-md max-w-2xl mx-auto">
                <div id="loading-area" class="flex flex-col justify-center items-center h-40 hidden">
                    <div class="spinner mb-2"></div>
                    <p id="loading-text" class="text-slate-600 font-semibold">Gerando Questões...</p>
                </div>
                <div id="quiz-content">
                    <p id="question-text" class="text-lg md:text-xl mb-6 min-h-[60px]"></p>
                    <!-- Botão "+ Texto" -->
                    <button id="show-text-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-lg mb-4 hidden">
                        + Texto
                    </button>
                    <div id="options-container" class="flex flex-col space-y-3">
                        <!-- Opções serão inseridas aqui -->
                    </div>
                </div>
            </main>

            <footer class="mt-6 flex flex-wrap justify-center items-center gap-4 max-w-2xl mx-auto">
                <button id="back-to-menu" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-4 rounded-lg transition-colors">
                    Menu
                </button>
                <!-- Botão "Perguntar ao Gramatiquinho" (visível apenas para quizzes normais) -->
                <button id="ask-friends-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-lg flex items-center">
                    <span class="help-icon">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                    </span> Perguntar ao Gramatiquinho (<span id="friends-help-count">3</span>)
                </button>
                <!-- Botão "Recurso da Questão" -->
                <button id="appeal-question-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-lg flex items-center hidden">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                    </svg>
                    Recurso da Questão
                </button>
                <button id="next-question" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg hidden">
                    Próxima Pergunta &rarr;
                </button>
                <!-- Botão de Mudo - REMOVIDO -->
            </footer>
        </div>

        <!-- Tela Final -->
        <div id="final-screen" class="hidden text-center bg-white p-8 rounded-xl shadow-md max-w-2xl mx-auto">
            <h2 class="text-3xl font-bold text-slate-700 mb-2">Quiz Finalizado!</h2>
            <p id="final-topic" class="text-xl text-sky-700 font-semibold mb-4"></p>
            <p class="text-lg text-slate-600 mb-1">Sua pontuação final foi:</p>
            <p id="final-score" class="text-6xl font-bold text-slate-800 mb-4"></p>
            <p id="final-time" class="text-lg text-slate-600 mb-8 hidden"></p> <!-- Tempo final do simulado -->
            <div class="flex flex-wrap justify-center gap-4">
                <button id="restart-quiz" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                    Tentar Novamente
                </button>
                <button id="back-to-menu-final" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-3 px-6 rounded-lg transition-colors">
                    Escolher outro Tópico
                </button>
                <!-- Novo botão para voltar à tela inicial -->
                <button id="back-to-home-from-final" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-3 px-6 rounded-lg transition-colors">
                    Voltar à Tela Inicial
                </button>
            </div>
        </div>

    </div>

    <!-- Modal de Estudo (antigo Modal de Explicação) -->
    <div id="study-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0" role="dialog" aria-modal="true" aria-labelledby="study-title">
        <div class="modal-container bg-white w-full max-w-md rounded-xl shadow-2xl p-6 md:p-8 relative transform scale-95 opacity-0">
            <h3 id="study-title" class="text-2xl font-bold text-sky-700 mb-4">
                <span class="professor-icon">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                </span> <span id="study-modal-title-text"></span>
            </h3>
            <!-- Novo wrapper para o conteúdo e o spinner -->
            <div id="study-content-wrapper">
                <div id="study-loading-area" class="flex flex-col justify-center items-center h-40 hidden">
                    <div class="spinner mb-2"></div>
                    <p class="text-slate-600 font-semibold">Carregando material de estudo...</p>
                </div>
                <div id="study-text" class="text-slate-600 space-y-3 prose max-w-none hidden">
                    <!-- Conteúdo de estudo será carregado aqui -->
                </div>
            </div>
            <button id="close-study-modal" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800 transition-colors" aria-label="Fechar explicação">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
    </div>

    <!-- Modal de Recurso da Questão -->
    <div id="appeal-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0" role="dialog" aria-modal="true" aria-labelledby="appeal-title">
        <div class="modal-container bg-white w-full max-w-md rounded-xl shadow-2xl p-6 md:p-8 relative transform scale-95 opacity-0">
            <h3 id="appeal-title" class="text-2xl font-bold text-orange-700 mb-4">
                <svg class="w-6 h-6 inline-block mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                </svg>
                Recurso da Questão
            </h3>
            <p class="text-slate-600 mb-4">Explique por que você acredita que a resposta está incorreta ou que sua resposta deveria ser considerada correta.</p>
            <textarea id="appeal-text-area" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 mb-4 h-32 resize-y" placeholder="Digite seu recurso aqui..."></textarea>
            <div id="appeal-response-container" class="bg-slate-50 p-3 rounded-lg border border-slate-200 hidden">
                <p class="font-semibold text-slate-700 mb-2">Avaliação do Gramatiquinho:</p>
                <div class="flex justify-center items-center h-16 hidden">
                    <div class="spinner"></div>
                </div>
                <p id="appeal-response-text" class="text-slate-600"></p>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="submit-appeal-btn" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-5 rounded-lg transition-colors shadow-lg">
                    Enviar Recurso
                </button>
                <button id="close-appeal-modal-btn" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-5 rounded-lg transition-colors">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Senha -->
    <div id="password-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0" role="dialog" aria-modal="true" aria-labelledby="password-title">
        <div class="modal-container bg-white w-full max-w-sm rounded-xl shadow-2xl p-6 md:p-8 relative transform scale-95 opacity-0">
            <h3 id="password-title" class="text-2xl font-bold text-slate-700 mb-4">Acesso Restrito</h3>
            <p class="text-slate-600 mb-4">Para continuar, por favor, insira a senha de administrador:</p>
            <input type="password" id="admin-password-input" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 mb-4" placeholder="Senha">
            <p id="password-error-message" class="text-red-500 text-sm mb-4 hidden">Senha incorreta. Tente novamente.</p>
            <div class="flex justify-end gap-3 mt-6">
                <button id="confirm-password-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-5 rounded-lg transition-colors shadow-lg">
                    Confirmar
                </button>
                <button id="cancel-password-btn" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-5 rounded-lg transition-colors">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Novo Modal de Distribuição de Questões -->
    <div id="question-distribution-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0" role="dialog" aria-modal="true" aria-labelledby="distribution-title">
        <div class="modal-container bg-white w-full max-w-md rounded-xl shadow-2xl p-6 md:p-8 relative transform scale-95 opacity-0">
            <h3 id="distribution-title" class="text-2xl font-bold text-sky-700 mb-4">Distribuir Questões por Tópico</h3>
            <p class="text-slate-600 mb-4">Defina quantas questões você quer de cada tópico selecionado. O total deve ser <span id="expected-total-questions" class="font-bold"></span>.</p>
            
            <div id="question-distribution-container" class="max-h-60 overflow-y-auto pr-2 mb-4 space-y-3">
                <!-- Inputs para distribuição de questões por tópico serão inseridos aqui -->
            </div>

            <div class="flex justify-between items-center mb-4">
                <button id="randomize-distribution-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-md">
                    Distribuir Aleatoriamente
                </button>
                <p class="text-slate-700 font-semibold">Total Atual: <span id="distribution-total-display" class="font-bold text-sky-700">0</span></p>
            </div>
            <p id="distribution-error-message" class="text-red-500 text-sm mb-4 hidden">A soma das questões não corresponde ao total esperado.</p>

            <div class="flex justify-end gap-3 mt-6">
                <button id="confirm-distribution-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-lg transition-colors shadow-lg opacity-50 cursor-not-allowed" disabled>
                    Confirmar e Iniciar Simulado
                </button>
                <button id="cancel-distribution-btn" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-5 rounded-lg transition-colors">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Novo Modal de Relatório de Desempenho -->
    <div id="performance-report-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0" role="dialog" aria-modal="true" aria-labelledby="report-title">
        <div class="modal-container bg-white w-full max-w-md rounded-xl shadow-2xl p-6 md:p-8 relative transform scale-95 opacity-0">
            <h3 id="report-title" class="text-2xl font-bold text-sky-700 mb-4">Relatório de Desempenho</h3>
            <div id="performance-report-content" class="text-slate-600 space-y-2 max-h-60 overflow-y-auto pr-2 mb-4">
                <!-- Conteúdo do relatório será inserido aqui -->
            </div>
            <div class="flex justify-end mt-4">
                <button id="close-report-modal-btn" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-5 rounded-lg transition-colors">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Nº de Questões -->
    <div id="num-questions-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0" role="dialog" aria-modal="true" aria-labelledby="num-questions-title">
        <div class="modal-container bg-white w-full max-w-xs rounded-xl shadow-2xl p-6 md:p-8 relative transform scale-95 opacity-0">
            <h3 id="num-questions-title" class="text-2xl font-bold text-blue-700 mb-4">Número de Questões</h3>
            <label for="modal-question-quantity-input" class="text-slate-700 font-semibold block mb-2">Quantidade:</label>
            <input type="number" id="modal-question-quantity-input" value="10" min="1" class="w-full p-2 border border-slate-300 rounded-lg text-center focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
            <div class="flex justify-end gap-3 mt-6">
                <button id="confirm-num-questions" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg transition-colors shadow-lg">
                    Confirmar
                </button>
                <button id="cancel-num-questions" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-5 rounded-lg transition-colors">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Nível -->
    <div id="difficulty-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0" role="dialog" aria-modal="true" aria-labelledby="difficulty-title">
        <div class="modal-container bg-white w-full max-w-xs rounded-xl shadow-2xl p-6 md:p-8 relative transform scale-95 opacity-0">
            <h3 id="difficulty-title" class="text-2xl font-bold text-purple-700 mb-4">Nível</h3>
            <div class="flex flex-col gap-3">
                <input type="radio" id="modal-difficulty-iniciante" name="modalDifficulty" value="iniciante" class="hidden">
                <label for="modal-difficulty-iniciante" class="difficulty-label px-4 py-2 border border-slate-300 rounded-lg cursor-pointer hover:bg-slate-200 transition-colors text-slate-700 text-center">Iniciante</label>
                <input type="radio" id="modal-difficulty-intermediario" name="modalDifficulty" value="intermediario" class="hidden">
                <label for="modal-difficulty-intermediario" class="difficulty-label px-4 py-2 border border-slate-300 rounded-lg cursor-pointer hover:bg-slate-200 transition-colors text-slate-700 text-center">Intermediário</label>
                <input type="radio" id="modal-difficulty-avancado" name="modalDifficulty" value="avancado" class="hidden">
                <label for="modal-difficulty-avancado" class="difficulty-label px-4 py-2 border border-slate-300 rounded-lg cursor-pointer hover:bg-slate-200 transition-colors text-slate-700 text-center">Avançado</label>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="confirm-difficulty" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-5 rounded-lg transition-colors shadow-lg">
                    Confirmar
                </button>
                <button id="cancel-difficulty" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-5 rounded-lg transition-colors">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Tipo de Gabarito -->
    <div id="response-mode-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0" role="dialog" aria-modal="true" aria-labelledby="response-mode-title">
        <div class="modal-container bg-white w-full max-w-xs rounded-xl shadow-2xl p-6 md:p-8 relative transform scale-95 opacity-0">
            <h3 id="response-mode-title" class="text-2xl font-bold text-orange-700 mb-4">Tipo de Gabarito</h3>
            <div class="flex flex-col gap-3">
                <input type="radio" id="modal-response-mode-certo-errado" name="modalResponseMode" value="certo-errado" class="hidden">
                <label for="modal-response-mode-certo-errado" class="response-mode-label px-4 py-2 border border-slate-300 rounded-lg cursor-pointer hover:bg-slate-200 transition-colors text-slate-700 text-center">Certo ou Errado</label>
                <input type="radio" id="modal-response-mode-multipla-escolha" name="modalResponseMode" value="multipla-escolha" class="hidden">
                <label for="modal-response-mode-multipla-escolha" class="response-mode-label px-4 py-2 border border-slate-300 rounded-lg cursor-pointer hover:bg-slate-200 transition-colors text-slate-700 text-center">Múltipla Escolha (5 opções)</label>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="confirm-response-mode" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-5 rounded-lg transition-colors shadow-lg">
                    Confirmar
                </button>
                <button id="cancel-response-mode" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-5 rounded-lg transition-colors">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Novo Modal para Exibição de Texto de Apoio -->
    <div id="text-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0" role="dialog" aria-modal="true" aria-labelledby="text-modal-title">
        <div class="modal-container bg-white w-full max-w-2xl rounded-xl shadow-2xl p-6 md:p-8 relative transform scale-95 opacity-0">
            <h3 id="text-modal-title" class="text-2xl font-bold text-sky-700 mb-4">Texto de Apoio</h3>
            <div id="text-modal-content" class="text-modal-content">
                <!-- O texto será inserido aqui -->
            </div>
            <button id="close-text-modal" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800 transition-colors" aria-label="Fechar texto">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
    </div>


    <script type="module">
        // Global variables
        let currentLevel = null;
        let selectedTopics = [];
        let questionQuantity = null;
        let difficulty = null;
        let responseMode = null;
        let quizQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let isSimulado = false;
        let timerInterval = null;
        let timeLeft = 0;
        let friendsHelpCount = 3; // Reset to default value as persistence is removed
        let performanceReport = {};
        let currentQuestionData = null;

        // --- Elementos do DOM ---
        const homeScreen = document.getElementById('home-screen');
        const topicSelectionScreen = document.getElementById('topic-selection-screen');
        const simuladoSetupScreen = document.getElementById('simulado-setup-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const finalScreen = document.getElementById('final-screen');

        const levelSelectButtons = document.querySelectorAll('.level-select-btn');
        const enterAppButton = document.getElementById('enter-app-btn');
        const topicContainerQuiz = document.getElementById('topic-container-quiz');
        const topicContainerSimulado = document.getElementById('topic-container-simulado');
        const questionQuantityQuizInput = document.getElementById('question-quantity-quiz');
        const startSelectedQuizButton = document.getElementById('start-selected-quiz');
        
        const btnNumQuestions = document.getElementById('btn-num-questions');
        const displayNumQuestions = document.getElementById('display-num-questions');
        const btnDifficulty = document.getElementById('btn-difficulty');
        const displayDifficulty = document.getElementById('display-difficulty');
        const btnResponseMode = document.getElementById('btn-response-mode');
        const displayResponseMode = document.getElementById('display-response-mode');

        const startSimuladoButton = document.getElementById('start-simulado');
        const backToHomeFromTopicsButton = document.getElementById('back-to-home-from-topics');
        const backToHomeFromSimuladoSetupButton = document.getElementById('back-to-home-from-simulado-setup');

        const quizTopicTitle = document.getElementById('quiz-topic-title');
        const questionCounter = document.getElementById('question-counter');
        const scoreDisplay = document.getElementById('score');
        const nextQuestionButton = document.getElementById('next-question');
        const backToMenuButton = document.getElementById('back-to-menu');
        const askFriendsButton = document.getElementById('ask-friends-btn');
        const friendsHelpCountSpan = document.getElementById('friends-help-count');
        const appealQuestionButton = document.getElementById('appeal-question-btn');
        const showTextButton = document.getElementById('show-text-button');

        const timerDisplayContainer = document.getElementById('timer-display-container');
        const timerDisplay = document.getElementById('timer-display');

        const finalScoreDisplay = document.getElementById('final-score');
        const finalTopicDisplay = document.getElementById('final-topic');
        const finalTimeDisplay = document.getElementById('final-time');
        const restartQuizButton = document.getElementById('restart-quiz');
        const backToMenuFinalButton = document.getElementById('back-to-menu-final');
        const backToHomeFromFinalButton = document.getElementById('back-to-home-from-final');

        const studyModal = document.getElementById('study-modal');
        const studyModalTitleText = document.getElementById('study-modal-title-text');
        const studyLoadingArea = document.getElementById('study-loading-area');
        const studyText = document.getElementById('study-text');
        const closeStudyModalButton = document.getElementById('close-study-modal');

        const appealModal = document.getElementById('appeal-modal');
        const appealTextArea = document.getElementById('appeal-text-area');
        const appealResponseContainer = document.getElementById('appeal-response-container');
        const appealResponseLoading = document.getElementById('appeal-response-loading');
        const appealResponseText = document.getElementById('appeal-response-text');
        const submitAppealButton = document.getElementById('submit-appeal-btn');
        const closeAppealModalButton = document.getElementById('close-appeal-modal-btn');

        const passwordModal = document.getElementById('password-modal');
        const adminPasswordInput = document.getElementById('admin-password-input');
        const passwordErrorMessage = document.getElementById('password-error-message');
        const confirmPasswordButton = document.getElementById('confirm-password-btn');
        const cancelPasswordButton = document.getElementById('cancel-password-btn');

        const questionDistributionModal = document.getElementById('question-distribution-modal');
        const expectedTotalQuestionsSpan = document.getElementById('expected-total-questions');
        const questionDistributionContainer = document.getElementById('question-distribution-container');
        const randomizeDistributionBtn = document.getElementById('randomize-distribution-btn');
        const distributionTotalDisplay = document.getElementById('distribution-total-display');
        const distributionErrorMessage = document.getElementById('distribution-error-message');
        const confirmDistributionBtn = document.getElementById('confirm-distribution-btn');
        const cancelDistributionBtn = document.getElementById('cancel-distribution-btn');

        const performanceReportModal = document.getElementById('performance-report-modal');
        const performanceReportContent = document.getElementById('performance-report-content');
        const closeReportModalBtn = document.getElementById('close-report-modal-btn');

        const numQuestionsModal = document.getElementById('num-questions-modal');
        const modalQuestionQuantityInput = document.getElementById('modal-question-quantity-input');
        const confirmNumQuestionsBtn = document.getElementById('confirm-num-questions');
        const cancelNumQuestionsBtn = document.getElementById('cancel-num-questions');

        const difficultyModal = document.getElementById('difficulty-modal');
        const modalDifficultyRadios = document.querySelectorAll('input[name="modalDifficulty"]');
        const confirmDifficultyBtn = document.getElementById('confirm-difficulty');
        const cancelDifficultyBtn = document.getElementById('cancel-difficulty');

        const responseModeModal = document.getElementById('response-mode-modal');
        const modalResponseModeRadios = document.querySelectorAll('input[name="modalResponseMode"]'); 
        const confirmResponseModeBtn = document.getElementById('confirm-response-mode');
        const cancelResponseModeBtn = document.getElementById('cancel-response-mode');

        const textModal = document.getElementById('text-modal');
        const textModalTitle = document.getElementById('text-modal-title');
        const textModalContent = document.getElementById('text-modal-content');
        const closeTextModalButton = document.getElementById('close-text-modal');

        // --- BANCO DE DADOS DE TÓPICOS E EXPLICAÇÕES (QUESTÕES SERÃO GERADAS PELA IA) ---
        const grammarData = [
            {
                category: "Fonética e Fonologia",
                levels: ["6EF", "7EF", "8EF", "9EF", "1EM", "2EM", "3EM", "enem"],
                topics: [
                    { id: 'fonemas', name: 'Fonemas e Letras', description: 'Diferença entre fonemas e letras, dígrafos e encontros consonantais.' },
                    { id: 'encontros-vocalicos', name: 'Encontros Vocálicos (Ditongo, Tritongo, Hiato)', description: 'Conceito e identificação de ditongos, tritongos e hiatos.' },
                    { id: 'divisao-silabica', name: 'Divisão Silábica', description: 'Regras de divisão silábicas, incluindo casos especiais.' },
                    { id: 'acentuacao', name: 'Acentuação Gráfica', description: 'Regras de oxítonas, paroxítonas, proparoxítonas, hiatos e ditongos abertos.' },
                    { id: 'ortografia', name: 'Ortografia', description: 'Uso correto das letras (s/z, g/j, x/ch, etc.) e o novo acordo ortográfico.' },
                    { id: 'hifen', name: 'Uso do Hífen', description: 'Regras de uso do hífen em diferentes contextos e o novo acordo ortográfico.' }
                ]
            },
            {
                category: "Morfologia",
                levels: ["6EF", "7EF", "8EF", "9EF", "1EM", "2EM", "3EM", "enem"],
                topics: [
                    { id: 'substantivo', name: 'Substantivo', description: 'Classificação, flexão de gênero, número e grau dos substantivos.' },
                    { id: 'adjetivo', name: 'Adjetivo', description: 'Classificação, flexão de gênero, número e grau dos adjetivos.' },
                    { id: 'artigo', name: 'Artigo', description: 'Definidos e indefinidos, seu uso e importância.' },
                    { id: 'numeral', name: 'Numeral', description: 'Classificação e uso dos numerais (cardinais, ordinais, multiplicativos, fracionários).' },
                    { id: 'pronome', name: 'Pronome', description: 'Classificação (pessoal, possessivo, demonstrativo, etc.) e seu uso.' },
                    { id: 'verbo', name: 'Verbo', description: 'Conjugação, tempos e modos verbais, verbos regulares e irregulares.' },
                    { id: 'adverbio', name: 'Advérbio', description: 'Classificação (tempo, lugar, modo, etc.) e locução adverbial.' },
                    { id: 'preposicao', name: 'Preposição', description: 'Conceito, classificação e combinação de preposições.' },
                    { id: 'conjuncao', name: 'Conjunção', description: 'Coordenativas e subordinativas, seu papel na conexão de orações.' },
                    { id: 'interjeicao', name: 'Interjeição', description: 'Expressão de emoções e sentimentos.' },
                    { id: 'estrutura-palavras', name: 'Estrutura e Formação das Palavras', description: 'Radical, afixos, desinências, derivação e composição.' }
                ]
            },
            {
                category: "Sintaxe",
                levels: ["8EF", "9EF", "1EM", "2EM", "3EM", "enem"],
                topics: [
                    { id: 'termos-essenciais', name: 'Termos Essenciais da Oração (Sujeito e Predicado)', description: 'Identificação e classificação de sujeito e predicado.' },
                    { id: 'termos-integrantes', name: 'Termos Integrantes da Oração (Objetos, Complemento Nominal, Agente da Passiva)', description: 'Funções sintáticas de objeto direto, indireto, complemento nominal e agente da passiva.' },
                    { id: 'termos-acessorios', name: 'Termos Acessórios da Oração (Adjunto Adnominal, Adjunto Adverbial, Aposto, Vocativo)', description: 'Funções sintáticas de adjunto adnominal, adjunto adverbial, aposto e vocativo.' },
                    { id: 'concordancia-verbal', name: 'Concordância Verbal', description: 'Regras de concordância do verbo com o sujeito.' },
                    { id: 'concordancia-nominal', name: 'Concordância Nominal', description: 'Regras de concordância entre substantivo, adjetivo, artigo, pronome e numeral.' },
                    { id: 'regencia-verbal', name: 'Regência Verbal', description: 'Relação entre o verbo e seus complementos.' },
                    { id: 'regencia-nominal', name: 'Regência Nominal', description: 'Relação entre o nome (substantivo, adjetivo, advérbio) e seu complemento.' },
                    { id: 'crase', name: 'Crase', description: 'Regras de uso do acento grave indicativo de crase.' },
                    { id: 'colocacao-pronominal', name: 'Colocação Pronominal (Próclise, Mesóclise, Ênclise)', description: 'Regras de posicionamento dos pronomes oblíquos átonos.' },
                    { id: 'vozes-verbais', name: 'Vozes Verbais (Ativa, Passiva, Reflexiva)', description: 'Identificação e transformação das vozes verbais.' },
                    { id: 'periodo-simples-composto', name: 'Período Simples e Período Composto', description: 'Diferença entre orações e períodos, coordenação e subordinação.' },
                    { id: 'oracoes-coordenadas', name: 'Orações Coordenadas', description: 'Classificação e uso das orações coordenadas (sindéticas e assindéticas).' },
                    { id: 'oracoes-subordinadas-substantivas', name: 'Orações Subordinadas Substantivas', description: 'Classificação e função das orações subordinadas substantivas.' },
                    { id: 'oracoes-subordinadas-adjetivas', name: 'Orações Subordinadas Adjetivas', description: 'Classificação e função das orações subordinadas adjetivas.' },
                    { id: 'oracoes-subordinadas-adverbiais', name: 'Orações Subordinadas Adverbiais', description: 'Classificação e função das orações subordinadas adverbiais.' },
                    { id: 'oracoes-reduzidas', name: 'Orações Reduzidas', description: 'Conceito e classificação de orações reduzidas (infinitivo, gerúndio, particípio).' },
                    { id: 'funcoes-que-se', name: 'Funções do "Que" e do "Se"', description: 'Análise sintática e morfológica das palavras "que" e "se".' },
                    { id: 'pontuacao', name: 'Pontuação (Vírgula, Ponto e Vírgula, Dois Pontos, Aspas, Parênteses)', description: 'Regras gerais e específicas de pontuação.' }
                ]
            },
            {
                category: "Semântica e Estilística",
                levels: ["9EF", "1EM", "2EM", "3EM", "enem"],
                topics: [
                    { id: 'sinonimia-antonimia', name: 'Sinonímia e Antonímia', description: 'Relações de sentido entre as palavras.' },
                    { id: 'homonimia-paronimia', name: 'Homonímia e Paronímia', description: 'Palavras com sons ou grafias semelhantes, mas significados diferentes.' },
                    { id: 'polissemia', name: 'Polissemia', description: 'Múltiplos significados de uma mesma palavra.' },
                    { id: 'conotacao-denotacao', name: 'Conotação e Denotação', description: 'Sentido real e figurado das palavras.' },
                    { id: 'figuras-linguagem', name: 'Figuras de Linguagem', description: 'Metáfora, comparação, personificação, hipérbole, eufemismo, etc.' },
                    { id: 'vicios-linguagem', name: 'Vícios de Linguagem', description: 'Ambiguidade, pleonasmo, cacofonia, barbarismo, etc.' }
                ]
            },
            {
                category: "Interpretação de Texto",
                levels: ["6EF", "7EF", "8EF", "9EF", "1EM", "2EM", "3EM", "enem"],
                topics: [
                    { id: 'leitura-interpretacao', name: 'Leitura e Interpretação de Textos', description: 'Análise de textos literários e não literários, identificação de informações implícitas e explícitas, intertextualidade.' },
                    { id: 'tipos-generos-textuais', name: 'Tipos e Gêneros Textuais', description: 'Diferença entre narração, descrição, dissertação, injunção e seus gêneros.' },
                    { id: 'coesao-coerencia', name: 'Coesão e Coerência Textual', description: 'Mecanismos de articulação e sentido do texto.' },
                    { id: 'inferencia-deducao', name: 'Inferência e Dedução', description: 'Capacidade de extrair informações implícitas e explícitas do texto.' },
                    { id: 'elementos-narrativos', name: 'Elementos Narrativos (Enredo, Personagens, Narrador, Tempo, Espaço)', description: 'Análise dos componentes de uma narrativa.' },
                    { id: 'argumentacao', name: 'Argumentação', description: 'Identificação de teses, argumentos e estratégias argumentativas.' }
                ]
            },
            {
                category: "Literatura",
                levels: ["1EM", "2EM", "3EM", "enem"],
                topics: [
                    { id: 'trovadorismo', name: 'Trovadorismo e Humanismo', description: 'Contexto histórico, características e principais autores.' },
                    { id: 'classicismo', name: 'Classicismo', description: 'Renascimento, Camões e a epopeia portuguesa.' },
                    { id: 'barroco', name: 'Barroco', description: 'Contexto, características e principais autores (Gregório de Matos, Padre Antônio Vieira).' },
                    { id: 'arcadismo', name: 'Arcadismo', description: 'Contexto, características e principais autores (Tomás Antônio Gonzaga, Cláudio Manuel da Costa).' },
                    { id: 'romantismo', name: 'Romantismo', description: 'Três gerações do Romantismo no Brasil e em Portugal, características e autores.' },
                    { id: 'realismo-naturalismo', name: 'Realismo e Naturalismo', description: 'Contexto, características e principais autores (Machado de Assis, Aluísio Azevedo).' },
                    { id: 'parnasianismo-simbolismo', name: 'Parnasianismo e Simbolismo', description: 'Características e principais autores de cada escola.' },
                    { id: 'pre-modernismo', name: 'Pré-Modernismo', description: 'Transição, características e autores (Euclides da Cunha, Lima Barreto).' },
                    { id: 'modernismo-1fase', name: 'Modernismo - 1ª Fase', description: 'Semana de Arte Moderna, características e autores (Mário de Andrade, Oswald de Andrade).' },
                    { id: 'modernismo-2fase', name: 'Modernismo - 2ª Fase', description: 'Prosa e Poesia, características e autores (Graciliano Ramos, Carlos Drummond de Andrade).' },
                    { id: 'modernismo-3fase', name: 'Modernismo - 3ª Fase (Pós-Modernismo)', description: 'Geração de 45, características e autores (João Cabral de Melo Neto, Clarice Lispector).' },
                    { id: 'literatura-contemporanea', name: 'Literatura Contemporânea', description: 'Tendências atuais na literatura brasileira.' }
                ]
            }
        ];

        // --- Funções Auxiliares ---

        /**
         * Alterna a visibilidade das telas.
         * @param {HTMLElement} screenToShow - A tela a ser exibida.
         */
        function showScreen(screenToShow) {
            [homeScreen, topicSelectionScreen, simuladoSetupScreen, quizScreen, finalScreen, studyModal, appealModal, passwordModal, questionDistributionModal, performanceReportModal, numQuestionsModal, difficultyModal, responseModeModal, textModal].forEach(screen => {
                if (screen === screenToShow) {
                    screen.classList.remove('hidden');
                    setTimeout(() => {
                        screen.classList.remove('opacity-0', 'scale-95');
                    }, 10); // Pequeno atraso para a transição CSS
                } else {
                    screen.classList.add('hidden', 'opacity-0', 'scale-95');
                }
            });
        }

        /**
         * Abre um modal com transição.
         * @param {HTMLElement} modalElement - O elemento do modal a ser aberto.
         */
        function openModal(modalElement) {
            modalElement.classList.remove('hidden');
            setTimeout(() => {
                modalElement.querySelector('.modal-container').classList.remove('opacity-0', 'scale-95');
                modalElement.classList.remove('opacity-0');
            }, 10);
        }

        /**
         * Fecha um modal com transição.
         * @param {HTMLElement} modalElement - O elemento do modal a ser fechado.
         */
        function closeModal(modalElement) {
            modalElement.querySelector('.modal-container').classList.add('opacity-0', 'scale-95');
            modalElement.classList.add('opacity-0');
            setTimeout(() => {
                modalElement.classList.add('hidden');
            }, 300); // Tempo da transição CSS
        }

        /**
         * Atualiza o estado do botão "Iniciar Quiz/Simulado"
         * Habilita se houver tópicos selecionados, quantidade de questões válida, dificuldade e modo de resposta selecionados.
         * @param {HTMLElement} buttonElement - O botão a ser atualizado.
         */
        function updateStartButtonState(buttonElement) {
            const hasSelectedTopics = selectedTopics.length > 0;
            // Para o simulado, todas as três configurações devem estar definidas
            const isSimuladoReady = hasSelectedTopics && questionQuantity !== null && difficulty !== null && responseMode !== null;

            if (isSimuladoReady) {
                buttonElement.classList.remove('opacity-50', 'cursor-not-allowed');
                buttonElement.disabled = false;
            } else {
                buttonElement.classList.add('opacity-50', 'cursor-not-allowed');
                buttonElement.disabled = true;
            }
        }

        /**
         * Renderiza os tópicos na tela de seleção.
         * @param {string} screenType - 'quiz' ou 'simulado'
         */
        function renderTopics(screenType) {
            const container = screenType === 'quiz' ? topicContainerQuiz : topicContainerSimulado;
            container.innerHTML = ''; // Limpa o container

            const availableTopics = grammarData.flatMap(category =>
                category.topics.filter(topic => category.levels.includes(currentLevel))
            );

            // Agrupa os tópicos pelas categorias disponíveis para o nível atual
            const categoriesForCurrentLevel = grammarData.filter(category =>
                category.levels.includes(currentLevel)
            );

            categoriesForCurrentLevel.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'bg-white p-6 rounded-xl shadow-md topic-card';
                categoryDiv.innerHTML = `
                    <h3 class="text-xl font-bold text-sky-700 mb-4">${category.category}</h3>
                    <div id="topic-list" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        ${category.topics.filter(topic => category.levels.includes(currentLevel)).map(topic => `
                            <label class="flex items-center p-3 border border-slate-300 rounded-lg cursor-pointer hover:bg-slate-50 transition-colors">
                                <input type="checkbox" data-topic-id="${topic.id}" data-topic-name="${topic.name}" class="topic-checkbox w-5 h-5 text-blue-600 rounded focus:ring-blue-500 mr-3">
                                <span class="text-slate-700 font-medium">${topic.name}</span>
                                <button type="button" class="study-button ml-auto text-blue-500 hover:text-blue-700 flex items-center" data-topic-id="${topic.id}" data-topic-name="${topic.name}" title="Estudar este tópico">
                                    <svg class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                                    </svg>
                                    <span>Estudar</span>
                                </button>
                            </label>
                        `).join('')}
                    </div>
                `;
                container.appendChild(categoryDiv);
            });

            // Adiciona listeners aos checkboxes de tópico
            container.querySelectorAll('.topic-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (event) => {
                    const topicId = event.target.dataset.topicId;
                    const topicName = event.target.dataset.topicName;
                    if (event.target.checked) {
                        selectedTopics.push({ id: topicId, name: topicName });
                    } else {
                        selectedTopics = selectedTopics.filter(topic => topic.id !== topicId);
                    }
                    updateStartButtonState(screenType === 'quiz' ? startSelectedQuizButton : startSimuladoButton);
                });
            });

            // Adiciona listeners aos botões de estudo
            container.querySelectorAll('.study-button').forEach(button => {
                button.addEventListener('click', async (event) => {
                    const topicId = event.currentTarget.dataset.topicId;
                    const topicName = event.currentTarget.dataset.topicName;
                    await openStudyModal(topicId, topicName, 'Estudar:');
                });
            });
        }

        /**
         * Abre o modal de estudo e carrega o conteúdo.
         * @param {string} topicId - O ID do tópico.
         * @param {string} topicName - O nome do tópico.
         * @param {string} modalTitlePrefix - Prefixo para o título do modal (ex: "Estudar:", "Explicação da Questão:")
         */
        async function openStudyModal(topicId, topicName, modalTitlePrefix) {
            studyModalTitleText.textContent = `${modalTitlePrefix} ${topicName}`;
            studyText.innerHTML = '';
            studyText.classList.add('hidden');
            studyLoadingArea.classList.remove('hidden');
            openModal(studyModal);

            try {
                const prompt = `Gere um material de estudo detalhado e didático sobre o tópico de gramática portuguesa "${topicName}" para o nível ${currentLevel}. Inclua exemplos claros e, se possível, um pequeno exercício com gabarito. Formate a resposta usando Markdown para facilitar a leitura.`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const apiKey = "AIzaSyB7qiadkipn35zzci0NwjZJUPsXS3q5rf8"; // Substitua pela sua chave de API Gemini
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    const markdownText = result.candidates[0].content.parts[0].text;
                    // Simples conversão de Markdown para HTML básico.
                    // Para uma conversão robusta, uma biblioteca de Markdown seria ideal.
                    let htmlContent = markdownText
                        .replace(/^### (.*$)/gim, '<h4>$1</h4>')
                        .replace(/^## (.*$)/gim, '<h3>$1</h3>')
                        .replace(/^# (.*$)/gim, '<h2>$1</h2>')
                        .replace(/^\* (.*$)/gim, '<li>$1</li>')
                        .replace(/^- (.*$)/gim, '<li>$1</li>')
                        .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
                        .replace(/\*(.*?)\*/gim, '<em>$1</em>')
                        .replace(/`(.*?)`/gim, '<code>$1</code>')
                        .replace(/\n/g, '<br>');

                    studyText.innerHTML = htmlContent;
                    studyText.classList.remove('hidden');
                } else {
                    studyText.textContent = 'Não foi possível carregar o material de estudo. Tente novamente.';
                    studyText.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Erro ao carregar material de estudo:', error);
                studyText.textContent = 'Ocorreu um erro ao carregar o material de estudo. Por favor, tente novamente mais tarde.';
                studyText.classList.remove('hidden');
            } finally {
                studyLoadingArea.classList.add('hidden');
            }
        }

        /**
         * Gera as questões do quiz/simulado usando a API Gemini.
         * @returns {Promise<Array>} Um array de objetos de questão.
         */
        async function generateQuestions() {
            // Re-query elements here to ensure they are available
            const loadingArea = document.getElementById('loading-area');
            const loadingText = document.getElementById('loading-text');
            const quizContent = document.getElementById('quiz-content');

            if (!loadingArea || !loadingText || !quizContent) {
                console.error("Erro: Um ou mais elementos de carregamento/quiz não foram encontrados.");
                // Display a user-friendly message on screen if loadingText is crucial
                const questionText = document.getElementById('question-text');
                const optionsContainer = document.getElementById('options-container');
                if (questionText) questionText.textContent = "Erro ao iniciar o quiz. Por favor, recarregue a página.";
                if (optionsContainer) optionsContainer.innerHTML = '';
                return []; // Return empty array to prevent further errors
            }

            loadingArea.classList.remove('hidden');
            quizContent.classList.add('hidden');
            loadingText.textContent = "Gerando Questões...";

            let allGeneratedQuestions = [];

            // Define o esquema de resposta esperado da API Gemini
            const responseSchema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        "textContext": { "type": "STRING" }, // Novo campo para o texto de apoio
                        "question": { "type": "STRING" },
                        "options": {
                            "type": "ARRAY",
                            "items": { "type": "STRING" }
                        },
                        "correctAnswer": { "type": "STRING" }
                    },
                    "propertyOrdering": ["textContext", "question", "options", "correctAnswer"] // Ordem atualizada
                }
            };

            try {
                // Itera sobre os tópicos selecionados para gerar questões para cada um
                for (const topic of selectedTopics) {
                    const numQuestionsForTopic = topic.quantity || Math.ceil(questionQuantity / selectedTopics.length);
                    let prompt;
                    // Verifica se o tópico é de interpretação de texto para incluir texto na questão
                    const isInterpretationTopic = ['leitura-interpretacao', 'tipos-generos-textuais', 'coesao-coerencia', 'inferencia-deducao', 'elementos-narrativos', 'argumentacao'].includes(topic.id);

                    if (isInterpretationTopic) {
                        let levelDescription = `para o nível ${currentLevel}`;
                        let styleDescription = "";
                        if (isSimulado) {
                            levelDescription = `para um simulado de nível ${difficulty}`;
                            styleDescription = ", no estilo ENEM";
                        } else if (currentLevel === 'enem') {
                            styleDescription = ", no estilo ENEM";
                        }

                        // Instruções para a IA: gerar o textContext primeiro
                        prompt = `Gere ${numQuestionsForTopic} questões sobre o tópico de gramática portuguesa "${topic.name}" ${levelDescription}${styleDescription}. Para cada questão, forneça um texto completo (literário ou não literário, notícia de jornal, etc., com no mínimo 100 palavras) como 'textContext'. Em seguida, forneça a pergunta baseada no texto que aborde intertextualidade, informações implícitas e explícitas. Se a questão pedir para identificar um termo, destaque-o usando a tag HTML <span class="text-blue-700 font-bold">termo</span> diretamente na pergunta. Não inclua tags <u> ou outros <span> para sublinhar ou destacar.`;
                        if (responseMode === 'multipla-escolha') {
                            prompt += ` Forneça 5 opções de resposta, cada uma como uma string sem o prefixo "A) ", "B) ", "C) ", "D) ", "E) ", e a resposta correta.`;
                        } else if (responseMode === 'certo-errado') {
                            prompt += ` Forneça uma afirmação e a resposta correta sendo "Certo" ou "Errado".`;
                        }
                        prompt += ` As questões devem ser desafiadoras e adequadas para o nível. A resposta deve ser um array JSON de objetos.`;

                    } else {
                        // Para tópicos não-interpretação, textContext será vazio
                        prompt = `Gere ${numQuestionsForTopic} questões sobre o tópico de gramática portuguesa "${topic.name}" para o nível ${currentLevel}.`;
                        if (isSimulado) {
                            prompt = `Gere ${numQuestionsForTopic} questões sobre o tópico de gramática portuguesa "${topic.name}" para um simulado de nível ${difficulty}.`;
                            if (responseMode === 'multipla-escolha') {
                                prompt += ` Para cada questão, forneça a pergunta. Se a questão pedir para identificar um termo, destaque-o usando a tag HTML <span class="text-blue-700 font-bold">termo</span> diretamente na pergunta. Não inclua tags <u> ou outros <span> para sublinhar ou destacar. Forneça 5 opções de resposta, cada uma como uma string sem o prefixo "A) ", "B) ", "C) ", "D) ", "E) ", e a resposta correta.`;
                            } else if (responseMode === 'certo-errado') {
                                prompt += ` Para cada questão, forneça uma afirmação e a resposta correta sendo "Certo" ou "Errado".`;
                            }
                            prompt += ` As questões devem ser desafiadoras e adequadas para o nível ${difficulty}. A resposta deve ser um array JSON de objetos.`;
                        } else {
                            prompt = `Gere ${numQuestionsForTopic} questões de múltipla escolha sobre o tópico de gramática portuguesa "${topic.name}" para o nível ${currentLevel}. Para cada questão, forneça a pergunta. Se a questão pedir para identificar um termo, destaque-o usando a tag HTML <span class="text-blue-700 font-bold">termo</span> diretamente na pergunta. Não inclua tags <u> ou outros <span> para sublinhar ou destacar. Forneça 4 opções de resposta, cada uma como uma string sem o prefixo "A) ", "B) ", "C) ", "D) ", e a resposta correta. A resposta deve ser um array JSON de objetos.`;
                        }
                        // Adiciona um textContext vazio para questões que não são de interpretação
                        prompt += ` O campo 'textContext' deve ser uma string vazia para estas questões.`;
                    }

                    const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = {
                        contents: chatHistory,
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: responseSchema
                        }
                    };
                    const apiKey = "YOUR_GEMINI_API_KEY"; // Substitua pela sua chave de API Gemini
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                        const jsonString = result.candidates[0].content.parts[0].text;
                        const parsedQuestions = JSON.parse(jsonString);
                        
                        // Adiciona o topicId e topicName a cada questão
                        parsedQuestions.forEach(q => {
                            q.topicId = topic.id;
                            q.topicName = topic.name;
                            // Garante que textContext exista, mesmo que vazio
                            q.textContext = q.textContext || '';
                        });
                        allGeneratedQuestions = allGeneratedQuestions.concat(parsedQuestions);
                    } else {
                        console.error(`Estrutura de resposta inesperada da API Gemini para o tópico ${topic.name}:`, result);
                    }
                }
                
                // Embaralha todas as questões geradas
                for (let i = allGeneratedQuestions.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [allGeneratedQuestions[i], allGeneratedQuestions[j]] = [allGeneratedQuestions[j], allGeneratedQuestions[i]];
                }

                return allGeneratedQuestions;

            } catch (error) {
                console.error('Erro ao gerar questões:', error);
                return [];
            } finally {
                if (loadingArea) loadingArea.classList.add('hidden');
                if (quizContent) quizContent.classList.remove('hidden');
            }
        }

        /**
         * Exibe a questão atual na tela.
         */
        function displayQuestion() {
            // Re-query elements here for robustness
            const questionText = document.getElementById('question-text');
            const optionsContainer = document.getElementById('options-container');

            if (!questionText || !optionsContainer) {
                console.error("Erro: Elementos de questão ou opções não encontrados.");
                return;
            }

            if (currentQuestionIndex < quizQuestions.length) {
                currentQuestionData = quizQuestions[currentQuestionIndex];
                questionText.innerHTML = currentQuestionData.question; // Alterado para innerHTML para renderizar tags HTML
                optionsContainer.innerHTML = ''; // Limpa as opções anteriores

                // Exibe ou esconde o botão "+ Texto"
                if (currentQuestionData.textContext && currentQuestionData.textContext.trim() !== '') {
                    showTextButton.classList.remove('hidden');
                } else {
                    showTextButton.classList.add('hidden');
                }

                if (isSimulado && responseMode === 'certo-errado') {
                    // Display "Certo" and "Errado" buttons
                    const certoButton = document.createElement('button');
                    certoButton.className = 'option-btn bg-slate-200 hover:bg-slate-300 text-slate-800 font-medium py-3 px-4 rounded-lg text-left shadow-sm border border-slate-300';
                    certoButton.textContent = 'Certo';
                    certoButton.dataset.index = 0; // Arbitrary index
                    certoButton.addEventListener('click', () => checkAnswer(certoButton, currentQuestionData.correctAnswer));
                    optionsContainer.appendChild(certoButton);

                    const erradoButton = document.createElement('button');
                    erradoButton.className = 'option-btn bg-slate-200 hover:bg-slate-300 text-slate-800 font-medium py-3 px-4 rounded-lg text-left shadow-sm border border-slate-300';
                    erradoButton.textContent = 'Errado';
                    erradoButton.dataset.index = 1; // Arbitrary index
                    erradoButton.addEventListener('click', () => checkAnswer(erradoButton, currentQuestionData.correctAnswer));
                    optionsContainer.appendChild(erradoButton);

                } else {
                    // Display multiple choice options (4 for quiz, 5 for simulado if selected)
                    const numOptions = (isSimulado && responseMode === 'multipla-escolha') ? 5 : 4;
                    for (let i = 0; i < numOptions; i++) {
                        const option = currentQuestionData.options[i];
                        const optionButton = document.createElement('button');
                        optionButton.className = 'option-btn bg-slate-200 hover:bg-slate-300 text-slate-800 font-medium py-3 px-4 rounded-lg text-left shadow-sm border border-slate-300';
                        // Removido o prefixo A, B, C, D, E
                        optionButton.textContent = option;
                        optionButton.dataset.index = i;
                        optionButton.addEventListener('click', () => checkAnswer(optionButton, currentQuestionData.correctAnswer));
                        optionsContainer.appendChild(optionButton);
                    }
                }

                questionCounter.textContent = `Questão ${currentQuestionIndex + 1} de ${quizQuestions.length}`;
                nextQuestionButton.classList.add('hidden'); // Esconde o botão de próxima pergunta
                appealQuestionButton.classList.add('hidden'); // Esconde o botão de recurso inicialmente
                if (!isSimulado) {
                    askFriendsButton.classList.remove('hidden'); // Mostra o botão de ajuda para quizzes
                } else {
                    askFriendsButton.classList.add('hidden'); // Esconde o botão de ajuda para simulados
                }
            } else {
                endQuiz();
            }
            updateProgressBar();
        }

        /**
         * Exibe uma explicação detalhada para a resposta incorreta.
         * @param {object} questionData - Dados da questão atual.
         * @param {string} selectedText - O texto da opção selecionada pelo usuário.
         */
        async function showExplanationForIncorrectAnswer(questionData, selectedText) {
            studyModalTitleText.textContent = 'Explicação da Questão';
            studyText.innerHTML = '';
            studyText.classList.add('hidden');
            studyLoadingArea.classList.remove('hidden');
            openModal(studyModal);

            try {
                const prompt = `Explique detalhadamente por que a resposta correta para a questão '${questionData.question}' é '${questionData.correctAnswer}'. Se o usuário escolheu '${selectedText}' como resposta, explique também por que '${selectedText}' está incorreta. Mantenha a explicação didática e clara, adequada ao nível ${currentLevel}.`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const apiKey = "YOUR_GEMINI_API_KEY"; // Substitua pela sua chave de API Gemini
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    const explanationText = result.candidates[0].content.parts[0].text;
                    let htmlContent = explanationText
                        .replace(/^### (.*$)/gim, '<h4>$1</h4>')
                        .replace(/^## (.*$)/gim, '<h3>$1</h3>')
                        .replace(/^# (.*$)/gim, '<h2>$1</h2>')
                        .replace(/^\* (.*$)/gim, '<li>$1</li>')
                        .replace(/^- (.*$)/gim, '<li>$1</li>')
                        .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
                        .replace(/\*(.*?)\*/gim, '<em>$1</em>')
                        .replace(/`(.*?)`/gim, '<code>$1</code>')
                        .replace(/\n/g, '<br>');

                    studyText.innerHTML = htmlContent;
                    studyText.classList.remove('hidden');
                } else {
                    studyText.textContent = 'Não foi possível carregar a explicação. Tente novamente.';
                    studyText.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Erro ao carregar explicação:', error);
                studyText.textContent = 'Ocorreu um erro ao carregar a explicação. Por favor, tente novamente mais tarde.';
                studyText.classList.remove('hidden');
            } finally {
                studyLoadingArea.classList.add('hidden');
            }
        }

        /**
         * Verifica a resposta selecionada pelo usuário.
         * @param {HTMLElement} selectedButton - O botão de opção clicado.
         * @param {string} correctAnswer - A resposta correta para a questão.
         */
        function checkAnswer(selectedButton, correctAnswer) {
            const optionsContainer = document.getElementById('options-container'); // Re-query here
            if (!optionsContainer) {
                console.error("Erro: optionsContainer não encontrado em checkAnswer.");
                return;
            }
            const allOptions = optionsContainer.querySelectorAll('.option-btn');
            let selectedText = selectedButton.textContent.trim();

            allOptions.forEach(button => {
                button.classList.add('disabled'); // Desabilita todos os botões após a seleção
                let optionText = button.textContent.trim();

                if (optionText === correctAnswer.trim()) {
                    button.classList.add('correct'); // Marca a resposta correta
                } else if (button === selectedButton) {
                    button.classList.add('incorrect'); // Marca a resposta incorreta escolhida
                }
            });

            if (selectedText === correctAnswer.trim()) {
                score++;
                scoreDisplay.textContent = score;
                // Garante que performanceReport[currentQuestionData.topicId] existe antes de tentar acessar 'correct'
                if (isSimulado && currentQuestionData && currentQuestionData.topicId) {
                    if (!performanceReport[currentQuestionData.topicId]) {
                        performanceReport[currentQuestionData.topicId] = { correct: 0, incorrect: 0 };
                    }
                    performanceReport[currentQuestionData.topicId].correct++;
                }
            } else {
                // Garante que performanceReport[currentQuestionData.topicId] existe antes de tentar acessar 'incorrect'
                if (isSimulado && currentQuestionData && currentQuestionData.topicId) {
                    if (!performanceReport[currentQuestionData.topicId]) {
                        performanceReport[currentQuestionData.topicId] = { correct: 0, incorrect: 0 };
                    }
                    performanceReport[currentQuestionData.topicId].incorrect++;
                }
                // Chama a função para mostrar a explicação se a resposta estiver incorreta
                showExplanationForIncorrectAnswer(currentQuestionData, selectedText);
            }

            nextQuestionButton.classList.remove('hidden'); // Mostra o botão de próxima pergunta
            appealQuestionButton.classList.remove('hidden'); // Mostra o botão de recurso após a resposta
            askFriendsButton.classList.add('hidden'); // Esconde o botão de ajuda após a resposta
        }

        /**
         * Avança para a próxima questão ou finaliza o quiz.
         */
        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < quizQuestions.length) {
                displayQuestion();
            } else {
                endQuiz();
            }
        }

        /**
         * Atualiza a barra de progresso do quiz.
         */
        function updateProgressBar() {
            const progressBar = document.getElementById('progress-bar'); // Re-query here
            if (!progressBar) {
                console.error("Erro: progressBar não encontrado em updateProgressBar.");
                return;
            }
            const progress = (currentQuestionIndex / quizQuestions.length) * 100;
            progressBar.style.width = `${progress}%`;
        }

        /**
         * Finaliza o quiz e exibe a tela final.
         */
        async function endQuiz() {
            if (isSimulado) {
                stopTimer();
                finalTimeDisplay.textContent = `Tempo total: ${formatTime(timeLeft)}`;
                finalTimeDisplay.classList.remove('hidden');
                // Exibir relatório de desempenho
                showPerformanceReport();
            } else {
                finalTimeDisplay.classList.add('hidden');
            }

            finalScoreDisplay.textContent = `${score}/${quizQuestions.length}`;
            finalTopicDisplay.textContent = isSimulado ? "Simulado" : selectedTopics.map(t => t.name).join(', ');
            showScreen(finalScreen);
        }

        /**
         * Inicia o timer do simulado.
         */
        function startTimer() {
            let seconds = 0;
            timerInterval = setInterval(() => {
                seconds++;
                timeLeft = seconds;
                timerDisplay.textContent = formatTime(seconds);
            }, 1000);
            timerDisplayContainer.classList.remove('hidden');
        }

        /**
         * Para o timer do simulado.
         */
        function stopTimer() {
            clearInterval(timerInterval);
            timerDisplayContainer.classList.add('hidden');
        }

        /**
         * Formata o tempo em minutos e segundos.
         * @param {number} totalSeconds - O total de segundos.
         * @returns {string} Tempo formatado (MM:SS).
         */
        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        /**
         * Abre o modal de recurso da questão e permite ao usuário enviar um recurso.
         */
        async function openAppealModal() {
            appealTextArea.value = '';
            appealResponseText.textContent = '';
            appealResponseContainer.classList.add('hidden');
            appealResponseLoading.classList.add('hidden');
            submitAppealButton.disabled = false;
            submitAppealButton.classList.remove('opacity-50', 'cursor-not-allowed');
            openModal(appealModal);
        }

        /**
         * Envia o recurso da questão para a API Gemini para avaliação.
         */
        async function submitAppeal() {
            const userAppeal = appealTextArea.value.trim();
            if (!userAppeal) {
                alert('Por favor, digite seu recurso antes de enviar.'); // Usando alert temporariamente, idealmente um modal customizado.
                return;
            }

            appealResponseContainer.classList.remove('hidden');
            appealResponseLoading.classList.add('hidden');
            appealResponseText.textContent = '';
            submitAppealButton.disabled = true;
            submitAppealButton.classList.add('opacity-50', 'cursor-not-allowed');

            try {
                const prompt = `Avalie o seguinte recurso de questão de gramática portuguesa. A questão era: "${currentQuestionData.question}". As opções eram: ${currentQuestionData.options.join(', ')}. A resposta correta oficial era: "${currentQuestionData.correctAnswer}". O usuário argumentou: "${userAppeal}". Com base nas regras da gramática portuguesa, o recurso do usuário é válido? Justifique sua resposta de forma clara e concisa.`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const apiKey = "YOUR_GEMINI_API_KEY"; // Substitua pela sua chave de API Gemini
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    appealResponseText.textContent = result.candidates[0].content.parts[0].text;
                } else {
                    appealResponseText.textContent = 'Não foi possível avaliar o recurso. Tente novamente.';
                }
            } catch (error) {
                console.error('Erro ao enviar recurso:', error);
                appealResponseText.textContent = 'Ocorreu um erro ao avaliar o recurso. Por favor, tente novamente mais tarde.';
            } finally {
                appealResponseLoading.classList.add('hidden');
            }
        }

        /**
         * Abre o modal de distribuição de questões para simulados.
         */
        function openQuestionDistributionModal() {
            questionDistributionContainer.innerHTML = '';
            let totalQuestions = questionQuantity; // Usa a variável global questionQuantity
            expectedTotalQuestionsSpan.textContent = totalQuestions;
            distributionTotalDisplay.textContent = '0';
            distributionErrorMessage.classList.add('hidden');
            confirmDistributionBtn.disabled = true;
            confirmDistributionBtn.classList.add('opacity-50', 'cursor-not-allowed');

            selectedTopics.forEach(topic => {
                const topicDiv = document.createElement('div');
                topicDiv.className = 'flex items-center justify-between bg-slate-50 p-3 rounded-lg border border-slate-200';
                topicDiv.innerHTML = `
                    <span class="text-slate-700 font-medium">${topic.name}:</span>
                    <input type="number" data-topic-id="${topic.id}" class="topic-distribution-input w-20 p-2 border border-slate-300 rounded-lg text-center" value="0" min="0">
                `;
                questionDistributionContainer.appendChild(topicDiv);
            });

            questionDistributionContainer.querySelectorAll('.topic-distribution-input').forEach(input => {
                input.addEventListener('input', updateDistributionTotal);
            });

            openModal(questionDistributionModal);
        }

        /**
         * Atualiza o total de questões distribuídas no modal de distribuição.
         */
        function updateDistributionTotal() {
            let currentTotal = 0;
            questionDistributionContainer.querySelectorAll('.topic-distribution-input').forEach(input => {
                currentTotal += parseInt(input.value) || 0;
            });
            distributionTotalDisplay.textContent = currentTotal;

            const expectedTotal = questionQuantity; // Usa a variável global questionQuantity
            if (currentTotal === expectedTotal) {
                distributionErrorMessage.classList.add('hidden');
                confirmDistributionBtn.disabled = false;
                confirmDistributionBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                distributionErrorMessage.classList.remove('hidden');
                confirmDistributionBtn.disabled = true;
                confirmDistributionBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        /**
         * Distribui as questões aleatoriamente entre os tópicos selecionados.
         */
        function randomizeDistribution() {
            let totalQuestions = questionQuantity; // Usa a variável global questionQuantity
            const numTopics = selectedTopics.length;
            if (numTopics === 0) return;

            const baseQuestions = Math.floor(totalQuestions / numTopics);
            let remainder = totalQuestions % numTopics;

            questionDistributionContainer.querySelectorAll('.topic-distribution-input').forEach((input, index) => {
                let quantity = baseQuestions;
                if (remainder > 0) {
                    quantity++;
                    remainder--;
                }
                input.value = quantity;
            });
            updateDistributionTotal();
        }

        /**
         * Confirma a distribuição das questões e inicia o simulado.
         */
        async function confirmDistributionAndStartSimulado() {
            selectedTopics.forEach(topic => {
                const input = questionDistributionContainer.querySelector(`input[data-topic-id="${topic.id}"]`);
                topic.quantity = parseInt(input.value) || 0;
            });
            closeModal(questionDistributionModal);
            await startQuizOrSimulado();
        }

        /**
         * Exibe o relatório de desempenho no modal.
         */
        function showPerformanceReport() {
            performanceReportContent.innerHTML = '';
            const totalCorrect = Object.values(performanceReport).reduce((sum, topic) => sum + topic.correct, 0);
            const totalIncorrect = Object.values(performanceReport).reduce((sum, topic) => sum + topic.incorrect, 0);
            const totalAnswered = totalCorrect + totalIncorrect;

            // Título e resumo geral
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'mb-4 pb-2 border-b border-slate-200';
            summaryDiv.innerHTML = `
                <p class="text-lg font-bold text-slate-700">Resumo Geral:</p>
                <p>Questões Respondidas: <span class="font-semibold">${totalAnswered}</span></p>
                <p class="text-green-600">Acertos: <span class="font-semibold">${totalCorrect}</span></p>
                <p class="text-red-600">Erros: <span class="font-semibold">${totalIncorrect}</span></p>
            `;
            performanceReportContent.appendChild(summaryDiv);

            // Desempenho por tópico
            const topicsDiv = document.createElement('div');
            topicsDiv.innerHTML = '<p class="text-lg font-bold text-slate-700 mb-2">Desempenho por Tópico:</p>';
            selectedTopics.forEach(topic => {
                const report = performanceReport[topic.id] || { correct: 0, incorrect: 0 };
                const topicItem = document.createElement('p');
                topicItem.className = 'text-slate-600';
                topicItem.innerHTML = `<strong>${topic.name}:</strong> Acertos: <span class="text-green-600">${report.correct}</span>, Erros: <span class="text-red-600">${report.incorrect}</span>`;
                topicsDiv.appendChild(topicItem);
            });
            performanceReportContent.appendChild(topicsDiv);

            openModal(performanceReportModal);
        }

        /**
         * Abre o modal de texto de apoio.
         * @param {string} text - O conteúdo do texto a ser exibido.
         */
        function openTextModal(text) {
            textModalContent.innerHTML = text;
            openModal(textModal);
        }

        /**
         * Fecha o modal de texto de apoio.
         */
        function closeTextModal() {
            closeModal(textModal);
        }


        // --- Gerenciamento de Telas e Fluxo ---

        /**
         * Inicializa a interface do usuário do aplicativo, mostrando a tela inicial.
         */
        function initializeAppUI() {
            showScreen(homeScreen);
            currentLevel = null;
            selectedTopics = [];
            questionQuantity = null; // Resetar ao iniciar
            difficulty = null; // Resetar ao iniciar
            responseMode = null; // Resetar ao iniciar

            enterAppButton.disabled = true;
            enterAppButton.classList.add('opacity-50', 'cursor-not-allowed');
            levelSelectButtons.forEach(btn => btn.classList.remove('bg-blue-700', 'bg-purple-700', 'bg-green-700', 'selected'));
            friendsHelpCountSpan.textContent = friendsHelpCount; // Atualiza a contagem de ajuda

            // Resetar displays dos botões de configuração do simulado
            displayNumQuestions.textContent = '---'; // Alterado para '---'
            displayDifficulty.textContent = '---'; // Alterado para '---'
            displayResponseMode.textContent = '---'; // Alterado para '---'
            updateStartButtonState(startSimuladoButton); // Atualiza o estado do botão "Iniciar Simulado"
        }

        /**
         * Inicia o quiz ou simulado.
         */
        async function startQuizOrSimulado() {
            if (selectedTopics.length === 0) {
                alert('Por favor, selecione pelo menos um tópico.');
                return;
            }

            // Inicializa o relatório de desempenho para simulado
            if (isSimulado) {
                performanceReport = {};
                selectedTopics.forEach(topic => {
                    performanceReport[topic.id] = { correct: 0, incorrect: 0 };
                });
            }

            showScreen(quizScreen);
            quizQuestions = [];
            currentQuestionIndex = 0;
            score = 0;
            scoreDisplay.textContent = score;
            // progressBar is now queried inside updateProgressBar
            const progressBar = document.getElementById('progress-bar');
            if (progressBar) progressBar.style.width = '0%';
            nextQuestionButton.classList.add('hidden');
            appealQuestionButton.classList.add('hidden'); // Garante que o botão de recurso esteja oculto no início
            showTextButton.classList.add('hidden'); // Esconde o botão "+ Texto" no início

            // Esconde/mostra o botão de ajuda dependendo se é simulado ou não
            if (isSimulado) {
                askFriendsButton.classList.add('hidden');
                startTimer(); // Inicia o timer para simulados
            } else {
                askFriendsButton.classList.remove('hidden');
                stopTimer(); // Garante que o timer esteja parado para quizzes
            }

            // Define o título do quiz
            if (isSimulado) {
                quizTopicTitle.textContent = `Simulado - Nível: ${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)}`;
            } else {
                quizTopicTitle.textContent = selectedTopics.map(t => t.name).join(', ');
            }

            quizQuestions = await generateQuestions();
            if (quizQuestions.length > 0) {
                displayQuestion();
            } else {
                const questionText = document.getElementById('question-text');
                const optionsContainer = document.getElementById('options-container');
                if (questionText) questionText.textContent = "Não foi possível carregar as questões. Tente novamente ou selecione outros tópicos.";
                if (optionsContainer) optionsContainer.innerHTML = '';
                nextQuestionButton.classList.add('hidden');
                askFriendsButton.classList.add('hidden');
                appealQuestionButton.classList.add('hidden');
                showTextButton.classList.add('hidden'); // Garante que o botão "+ Texto" esteja oculto
            }
        }

        // --- Event Listeners ---

        // Seleção de Nível na Tela Inicial
        levelSelectButtons.forEach(button => {
            button.addEventListener('click', () => {
                levelSelectButtons.forEach(btn => btn.classList.remove('bg-blue-700', 'bg-purple-700', 'bg-green-700', 'selected'));
                button.classList.add('selected'); // Adiciona uma classe para indicar seleção
                // Adiciona a cor de fundo apropriada ao botão selecionado
                if (button.dataset.level.includes('EF')) {
                    button.classList.add('bg-blue-700');
                } else if (button.dataset.level.includes('EM')) {
                    button.classList.add('bg-purple-700');
                } else if (button.dataset.level === 'enem') {
                    button.classList.add('bg-green-700');
                }
                currentLevel = button.dataset.level;
                enterAppButton.disabled = false;
                enterAppButton.classList.remove('opacity-50', 'cursor-not-allowed');
            });
        });

        // Botão "Iniciar" na Tela Inicial
        enterAppButton.addEventListener('click', () => {
            selectedTopics = []; // Reseta tópicos selecionados ao entrar na tela de seleção
            if (currentLevel === 'enem') {
                isSimulado = true;
                renderTopics('simulado');
                showScreen(simuladoSetupScreen);
                // Resetar estados e displays dos botões de configuração do simulado
                questionQuantity = null;
                difficulty = null;
                responseMode = null;
                displayNumQuestions.textContent = '---'; // Alterado para '---'
                displayDifficulty.textContent = '---'; // Alterado para '---'
                displayResponseMode.textContent = '---'; // Alterado para '---'
                updateStartButtonState(startSimuladoButton);
            } else {
                isSimulado = false;
                renderTopics('quiz');
                showScreen(topicSelectionScreen);
                updateStartButtonState(startSelectedQuizButton);
            }
        });

        // Input de quantidade de questões para Quiz
        questionQuantityQuizInput.addEventListener('input', () => {
            questionQuantity = parseInt(questionQuantityQuizInput.value);
            updateStartButtonState(startSelectedQuizButton);
        });

        // --- Event Listeners para os novos botões de configuração do Simulado ---
        btnNumQuestions.addEventListener('click', () => {
            modalQuestionQuantityInput.value = questionQuantity || 10; // Preenche com o valor atual ou 10
            openModal(numQuestionsModal);
        });

        confirmNumQuestionsBtn.addEventListener('click', () => {
            questionQuantity = parseInt(modalQuestionQuantityInput.value);
            displayNumQuestions.textContent = `${questionQuantity} Questões`;
            closeModal(numQuestionsModal);
            updateStartButtonState(startSimuladoButton);
        });

        cancelNumQuestionsBtn.addEventListener('click', () => closeModal(numQuestionsModal));

        btnDifficulty.addEventListener('click', () => {
            // Pre-seleciona o radio button se a dificuldade já estiver definida
            modalDifficultyRadios.forEach(radio => {
                radio.checked = (radio.value === difficulty);
                // Remove a classe 'selected' de todos os labels e adiciona ao selecionado
                document.querySelector(`label[for="${radio.id}"]`).classList.remove('selected');
                if (radio.checked) {
                    document.querySelector(`label[for="${radio.id}"]`).classList.add('selected');
                }
            });
            openModal(difficultyModal);
        });

        modalDifficultyRadios.forEach(radio => {
            radio.addEventListener('change', (event) => {
                // Atualiza a seleção visual dentro do modal
                document.querySelectorAll('input[name="modalDifficulty"] + label').forEach(label => label.classList.remove('selected'));
                document.querySelector(`label[for="${event.target.id}"]`).classList.add('selected');
            });
        });

        confirmDifficultyBtn.addEventListener('click', () => {
            const selectedRadio = document.querySelector('input[name="modalDifficulty"]:checked');
            if (selectedRadio) {
                difficulty = selectedRadio.value;
                displayDifficulty.textContent = selectedRadio.nextElementSibling.textContent; // Texto do label
                closeModal(difficultyModal);
                updateStartButtonState(startSimuladoButton);
            } else {
                alert('Por favor, selecione um nível.');
            }
        });

        cancelDifficultyBtn.addEventListener('click', () => closeModal(difficultyModal));

        btnResponseMode.addEventListener('click', () => {
            // Pre-seleciona o radio button se o modo de resposta já estiver definido
            modalResponseModeRadios.forEach(radio => {
                radio.checked = (radio.value === responseMode);
                // Remove a classe 'selected' de todos os labels e adiciona ao selecionado
                document.querySelector(`label[for="${radio.id}"]`).classList.remove('selected');
                if (radio.checked) {
                    document.querySelector(`label[for="${radio.id}"]`).classList.add('selected');
                }
            });
            openModal(responseModeModal);
        });

        modalResponseModeRadios.forEach(radio => {
            radio.addEventListener('change', (event) => {
                // Atualiza a seleção visual dentro do modal
                document.querySelectorAll('input[name="modalResponseMode"] + label').forEach(label => label.classList.remove('selected'));
                document.querySelector(`label[for="${event.target.id}"]`).classList.add('selected');
            });
        });

        confirmResponseModeBtn.addEventListener('click', () => {
            const selectedRadio = document.querySelector('input[name="modalResponseMode"]:checked');
            if (selectedRadio) {
                responseMode = selectedRadio.value;
                displayResponseMode.textContent = selectedRadio.nextElementSibling.textContent; // Texto do label
                closeModal(responseModeModal);
                updateStartButtonState(startSimuladoButton);
            } else {
                alert('Por favor, selecione um tipo de gabarito.');
            }
        });

        cancelResponseModeBtn.addEventListener('click', () => closeModal(responseModeModal));


        // Botão "Iniciar Simulado" (abre modal de distribuição ou inicia direto)
        startSimuladoButton.addEventListener('click', () => {
            if (selectedTopics.length > 1 && questionQuantity > 0) { // Usa questionQuantity global
                openQuestionDistributionModal();
            } else {
                // Se apenas um tópico ou zero questões, não precisa de distribuição
                selectedTopics.forEach(topic => topic.quantity = questionQuantity / selectedTopics.length || 0);
                startQuizOrSimulado();
            }
        });

        // Botões de voltar para a tela inicial
        backToHomeFromTopicsButton.addEventListener('click', initializeAppUI);
        backToHomeFromSimuladoSetupButton.addEventListener('click', initializeAppUI);
        backToHomeFromFinalButton.addEventListener('click', initializeAppUI);

        // Botão "Próxima Pergunta"
        nextQuestionButton.addEventListener('click', nextQuestion);

        // Botão "Menu" na tela do quiz
        backToMenuButton.addEventListener('click', () => {
            stopTimer(); // Garante que o timer pare se o usuário voltar ao menu
            if (isSimulado) {
                showScreen(simuladoSetupScreen);
            } else {
                showScreen(topicSelectionScreen);
            }
        });

        // Botão "Tentar Novamente" na tela final
        restartQuizButton.addEventListener('click', startQuizOrSimulado);

        // Botão "Escolher outro Tópico" na tela final
        backToMenuFinalButton.addEventListener('click', () => {
            if (isSimulado) {
                showScreen(simuladoSetupScreen);
            } else {
                showScreen(topicSelectionScreen);
            }
        });

        // Botão "Perguntar ao Gramatiquinho"
        askFriendsButton.addEventListener('click', async () => {
            if (friendsHelpCount > 0) {
                if (currentQuestionData) {
                    friendsHelpCount--;
                    friendsHelpCountSpan.textContent = friendsHelpCount;
                    await openStudyModal('current-question-help', `Ajuda sobre a Questão Atual: ${currentQuestionData.question}`, 'Ajuda:');
                } else {
                    alert('Não há questão ativa para pedir ajuda.'); // Idealmente um modal customizado
                }
            } else {
                alert('Você não tem mais ajudas do Gramatiquinho!'); // Idealmente um modal customizado
            }
        });

        // Botão "Recurso da Questão"
        appealQuestionButton.addEventListener('click', openAppealModal);

        // Fechar Modal de Estudo
        closeStudyModalButton.addEventListener('click', () => closeModal(studyModal));

        // Enviar Recurso
        submitAppealButton.addEventListener('click', submitAppeal);

        // Fechar Modal de Recurso
        closeAppealModalButton.addEventListener('click', () => closeModal(appealModal));

        // Botão para randomizar distribuição de questões
        randomizeDistributionBtn.addEventListener('click', randomizeDistribution);

        // Botão para confirmar distribuição e iniciar simulado
        confirmDistributionBtn.addEventListener('click', confirmDistributionAndStartSimulado);

        // Botão para cancelar distribuição
        cancelDistributionBtn.addEventListener('click', () => closeModal(questionDistributionModal));

        // Fechar Modal de Relatório de Desempenho
        closeReportModalBtn.addEventListener('click', () => closeModal(performanceReportModal));

        // Event Listeners para o novo modal de texto
        showTextButton.addEventListener('click', () => {
            if (currentQuestionData && currentQuestionData.textContext) {
                openTextModal(currentQuestionData.textContext);
            }
        });
        closeTextModalButton.addEventListener('click', closeTextModal);


        // Inicializa o aplicativo ao carregar a página
        initializeAppUI();
    </script>
</body>
</html>
